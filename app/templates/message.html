{% extends "base.html" %}
{% block title %}Messages{% endblock %}

{% block content %}
<div class="chat-container" style="max-width: 700px; margin: auto; padding: 20px;">
    <h3>ðŸ“¨ Encrypted Messages</h3>

    <!-- Current user info -->
    <input type="hidden" id="current-id" value="{{ current_user.id }}">
    <input type="hidden" id="current-email" value="{{ current_user.email }}">
    <input type="hidden" id="current-username" value="{{ current_user.username }}">

    <!-- User selector with reload on change -->
    <form method="get" action="{{ url_for('main.messages') }}">
        <div class="mb-3">
            <label for="recipient" class="form-label">Send To:</label>
            <select name="recipient_id" id="recipient" class="form-select" onchange="this.form.submit()">
                <option disabled selected>Select a user</option>
                {% for user in users %}
                    {% if user.id != current_user.id %}
                        <option value="{{ user.id }}" {% if user.id == selected_user_id %}selected{% endif %}>
                            {{ user.email }}
                        </option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>
    </form>

    <!-- Chat history box -->
    <div id="messages" class="chat-box">
        {% for msg in history %}
            {% set is_sender = msg.sender_id == current_user.id %}
            <div class="message-bubble {{ 'sent' if is_sender else 'received' }}">
                <div class="message-header">
                    <img src="/static/uploads/profile_images/user_{{ msg.sender_id }}.png" class="profile-img">
                    <strong>{{ msg.sender.email.split('@')[0] }}</strong>
                    <small>({{ msg.sender.email }})</small>
                </div>
                <div class="message-body">
                    {% if msg.is_file %}
                        ðŸ“Ž <a href="{{ msg.file_data }}" download="{{ msg.filename }}">{{ msg.filename }}</a>
                    {% else %}
                        {{ msg.file_data }}
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>

    {% if selected_user_id %}
    <!-- Message input box -->
    <div class="input-group mt-3">
        <input type="text" id="message" class="form-control" placeholder="Type your message...">
        <input type="file" id="fileInput" class="form-control">
        <button class="btn btn-primary" onclick="sendMessage()">Send</button>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
    const socket = io();

    function sendMessage() {
        const recipientId = document.getElementById('recipient').value;
        const message = document.getElementById('message').value.trim();
        const fileInput = document.getElementById('fileInput');
        const currentEmail = document.getElementById('current-email').value;
        const currentId = document.getElementById('current-id').value;
        const currentUsername = document.getElementById('current-username').value;

        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function (e) {
                socket.emit('private_file', {
                    recipient_id: recipientId,
                    file_name: file.name,
                    file_data: e.target.result,
                    sender_email: currentEmail
                });
            };
            reader.readAsDataURL(file);
        } else if (message) {
            socket.emit('private_message', {
                recipient_id: recipientId,
                msg: message,
                sender_email: currentEmail,
                sender_id: currentId,
                username: currentUsername
            });
        }

        document.getElementById('message').value = '';
        fileInput.value = '';
    }
</script>

<style>
.chat-box {
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 15px;
    background: #f9f9f9;
    max-height: 400px;
    overflow-y: auto;
}

.message-bubble {
    margin-bottom: 12px;
    padding: 10px;
    border-radius: 8px;
    max-width: 75%;
    color: black;
    clear: both;
}

.sent {
    background-color: #dcf8c6;
    float: right;
}

.received {
    background-color: #f1f0f0;
    float: left;
}

.message-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
}

.message-body {
    white-space: pre-wrap;
    word-wrap: break-word;
}

.profile-img {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
}
</style>
{% endblock %}
